
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.5">
    
    
      
        <title>Istio - Argo Rollouts - Kubernetes Progressive Delivery Controller</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Work Sans";--md-code-font-family:""}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-105170809-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#istio" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Argo Rollouts - Kubernetes Progressive Delivery Controller" class="md-header__button md-logo" aria-label="Argo Rollouts - Kubernetes Progressive Delivery Controller" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Argo Rollouts - Kubernetes Progressive Delivery Controller
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Istio
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/argoproj/argo-rollouts/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Argo Rollouts - Kubernetes Progressive Delivery Controller" class="md-nav__button md-logo" aria-label="Argo Rollouts - Kubernetes Progressive Delivery Controller" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    Argo Rollouts - Kubernetes Progressive Delivery Controller
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/argoproj/argo-rollouts/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Getting Started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/" class="md-nav__link">
        Basic Usage
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/ambassador/" class="md-nav__link">
        Ambassador
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/alb/" class="md-nav__link">
        AWS ALB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/istio/" class="md-nav__link">
        Istio
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/nginx/" class="md-nav__link">
        NGINX
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/smi/" class="md-nav__link">
        SMI
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../dashboard/" class="md-nav__link">
        Dashboard
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Rollout
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Rollout" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Rollout
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_1" type="checkbox" id="__nav_7_1" >
      
      <label class="md-nav__link" for="__nav_7_1">
        Deployment Strategies
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Deployment Strategies" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_1">
          <span class="md-nav__icon md-icon"></span>
          Deployment Strategies
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../bluegreen/" class="md-nav__link">
        BlueGreen
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../canary/" class="md-nav__link">
        Canary
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../specification/" class="md-nav__link">
        Rollout Spec
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hpa-support/" class="md-nav__link">
        HPA
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ephemeral-metadata/" class="md-nav__link">
        Ephemeral Metadata
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../restart/" class="md-nav__link">
        Restarting Rollouts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../anti-affinity/anti-affinity/" class="md-nav__link">
        Anti Affinity
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kustomize/" class="md-nav__link">
        Kustomize
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../controller-metrics/" class="md-nav__link">
        Controller Metrics
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      <label class="md-nav__link" for="__nav_8">
        Traffic Management
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Traffic Management" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Traffic Management
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ambassador/" class="md-nav__link">
        Ambassador
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../alb/" class="md-nav__link">
        AWS ALB
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Istio
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Istio
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    How it works
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-level-traffic-splitting" class="md-nav__link">
    Host-level Traffic Splitting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subset-level-traffic-splitting" class="md-nav__link">
    Subset-level Traffic Splitting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparison-between-approaches" class="md-nav__link">
    Comparison Between Approaches
  </a>
  
    <nav class="md-nav" aria-label="Comparison Between Approaches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-requirements" class="md-nav__link">
    DNS requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrating-with-gitops" class="md-nav__link">
    Integrating with GitOps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    Alternatives Considered
  </a>
  
    <nav class="md-nav" aria-label="Alternatives Considered">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rollout-ownership-over-the-virtual-service" class="md-nav__link">
    Rollout ownership over the Virtual Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#istio-support-through-the-smi-adapter-for-istio" class="md-nav__link">
    Istio support through the SMI Adapter for Istio
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../nginx/" class="md-nav__link">
        NGINX
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../smi/" class="md-nav__link">
        SMI
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        Analysis
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Analysis" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Analysis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../analysis/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/prometheus/" class="md-nav__link">
        Prometheus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/datadog/" class="md-nav__link">
        DataDog
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/newrelic/" class="md-nav__link">
        NewRelic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/wavefront/" class="md-nav__link">
        Wavefront
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/job/" class="md-nav__link">
        Job
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/web/" class="md-nav__link">
        Web
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../analysis/kayenta/" class="md-nav__link">
        Kayenta
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../experiment/" class="md-nav__link">
        Experiments
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      <label class="md-nav__link" for="__nav_11">
        Kubectl Plugin
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubectl Plugin" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Kubectl Plugin
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../kubectl-plugin/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11_2" type="checkbox" id="__nav_11_2" >
      
      <label class="md-nav__link" for="__nav_11_2">
        Commands
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Commands" data-md-level="2">
        <label class="md-nav__title" for="__nav_11_2">
          <span class="md-nav__icon md-icon"></span>
          Commands
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts/" class="md-nav__link">
        Rollouts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_abort/" class="md-nav__link">
        Rollouts Abort
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_create/" class="md-nav__link">
        Rollouts Create
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_create_analysisrun/" class="md-nav__link">
        Rollouts Create Analysisrun
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_dashboard/" class="md-nav__link">
        Rollouts Dashboard
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_get/" class="md-nav__link">
        Rollouts Get
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_get_experiment/" class="md-nav__link">
        Rollouts Get Experiment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_get_rollout/" class="md-nav__link">
        Rollouts Get Rollout
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_lint/" class="md-nav__link">
        Rollouts Lint
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_list/" class="md-nav__link">
        Rollouts List
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_list_experiments/" class="md-nav__link">
        Rollouts List Experiments
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_list_rollouts/" class="md-nav__link">
        Rollouts List Rollouts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_pause/" class="md-nav__link">
        Rollouts Pause
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_promote/" class="md-nav__link">
        Rollouts Promote
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_restart/" class="md-nav__link">
        Rollouts Restart
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_retry/" class="md-nav__link">
        Rollouts Retry
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_retry_experiment/" class="md-nav__link">
        Rollouts Retry Experiment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_retry_rollout/" class="md-nav__link">
        Rollouts Retry Rollout
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_set/" class="md-nav__link">
        Rollouts Set
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_set_image/" class="md-nav__link">
        Rollouts Set Image
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_status/" class="md-nav__link">
        Rollouts Status
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_terminate/" class="md-nav__link">
        Rollouts Terminate
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_terminate_analysisrun/" class="md-nav__link">
        Rollouts Terminate Analysisrun
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_terminate_experiment/" class="md-nav__link">
        Rollouts Terminate Experiment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_undo/" class="md-nav__link">
        Rollouts Undo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../generated/kubectl-argo-rollouts/kubectl-argo-rollouts_version/" class="md-nav__link">
        Rollouts Version
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../best-practices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../migrating/" class="md-nav__link">
        Migrating
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../FAQ/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../security/" class="md-nav__link">
        Security
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_17" type="checkbox" id="__nav_17" >
      
      <label class="md-nav__link" for="__nav_17">
        Contributing
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Contributing" data-md-level="1">
        <label class="md-nav__title" for="__nav_17">
          <span class="md-nav__icon md-icon"></span>
          Contributing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        Contribution Guide
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/setup/" class="md-nav__link">
        Environment Setup
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/argoproj/argo-rollouts/releases" class="md-nav__link">
        Releases ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/argoproj/argo-rollouts/milestones" class="md-nav__link">
        Roadmap ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://blog.argoproj.io/" class="md-nav__link">
        Blog ⧉
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    How it works
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-level-traffic-splitting" class="md-nav__link">
    Host-level Traffic Splitting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subset-level-traffic-splitting" class="md-nav__link">
    Subset-level Traffic Splitting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparison-between-approaches" class="md-nav__link">
    Comparison Between Approaches
  </a>
  
    <nav class="md-nav" aria-label="Comparison Between Approaches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-requirements" class="md-nav__link">
    DNS requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrating-with-gitops" class="md-nav__link">
    Integrating with GitOps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alternatives-considered" class="md-nav__link">
    Alternatives Considered
  </a>
  
    <nav class="md-nav" aria-label="Alternatives Considered">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rollout-ownership-over-the-virtual-service" class="md-nav__link">
    Rollout ownership over the Virtual Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#istio-support-through-the-smi-adapter-for-istio" class="md-nav__link">
    Istio support through the SMI Adapter for Istio
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/argoproj/argo-rollouts/edit/master/docs/features/traffic-management/istio.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="istio">Istio<a class="headerlink" href="#istio" title="Permanent link">&para;</a></h1>
<p><a href="https://istio.io/">Istio</a> is a service mesh that offers a rich feature-set to control the flow of
traffic to a web service. Istio offers this functionality through a set of CRDs, and Argo Rollouts
automates the management of these resources to provide advanced traffic shaping capabilities to the
different versions of the Rollout during an update.</p>
<h2 id="how-it-works">How it works<a class="headerlink" href="#how-it-works" title="Permanent link">&para;</a></h2>
<p>Traffic splitting is accomplished in Istio by adjusting traffic weights defined in an 
<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/">Istio VirtualService</a>.
When using Argo Rollouts with Istio, a user deploys a VirtualService containing at least one
<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute">HTTP route</a> containing two
<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRouteDestination">HTTP route destinations</a>:
a route destination targeting the pods of canary ReplicaSet, and a route destination targeting the pods
stable ReplicaSet. Istio provides two approaches for weighted traffic splitting, both approaches
are available as options in Argo Rollouts:</p>
<ol>
<li><a href="#host-level-traffic-splitting">Host-level traffic splitting</a></li>
<li><a href="#subset-level-traffic-splitting">Subset-lvel traffic splitting</a></li>
</ol>
<h2 id="host-level-traffic-splitting">Host-level Traffic Splitting<a class="headerlink" href="#host-level-traffic-splitting" title="Permanent link">&para;</a></h2>
<p>The first approach to traffic splitting using Argo Rollouts and Istio, is splitting between two
hostnames, or Kubernetes Services: a canary Service and a stable Service. This approach is
similar to the way all other Argo Rollouts mesh/ingress-controller integrations work (e.g. ALB, SMI,
Nginx). Using this approach, the user is required to deploy the following resources:</p>
<ul>
<li>Rollout</li>
<li>Service (canary)</li>
<li>Service (stable)</li>
<li>VirtualService</li>
</ul>
<p>The Rollout should define the following fields:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">argoproj.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Rollout</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
  <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span>
    <span class="nt">canary</span><span class="p">:</span>
      <span class="nt">canaryService</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary-svc</span>  <span class="c1"># required</span>
      <span class="nt">stableService</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable-svc</span>  <span class="c1"># required</span>
      <span class="nt">trafficRouting</span><span class="p">:</span>
        <span class="nt">istio</span><span class="p">:</span>
          <span class="nt">virtualService</span><span class="p">:</span> 
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-vsvc</span>   <span class="c1"># required</span>
            <span class="nt">routes</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>            <span class="c1"># required</span>
      <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">setWeight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
      <span class="p p-Indicator">-</span> <span class="nt">pause</span><span class="p">:</span>
          <span class="nt">duration</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
</code></pre></div>
<p>The VirtualService must contain an HTTP route with a name referenced in the Rollout, containing
two route destinations with <code>host</code> values that match the <code>canaryService</code> and <code>stableService</code> 
referenced in the Rollout.  If the VirtualService is defined in a different namespace than the rollout,
its name should be <code>rollout-vsvc.&lt;vsvc namespace name&gt;</code>. Note that Istio requires that all weights add to
100, so the initial weights can be be 100% to stable, and 0% to canary.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1alpha3</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-vsvc</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">gateways</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">istio-rollout-gateway</span>
  <span class="nt">hosts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">istio-rollout.dev.argoproj.io</span>
  <span class="nt">http</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>        <span class="c1"># referenced in canary.trafficRouting.istio.virtualService.routes</span>
    <span class="nt">route</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">destination</span><span class="p">:</span>
        <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable-svc</span> <span class="c1"># referenced in canary.stableService</span>
      <span class="nt">weight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="p p-Indicator">-</span> <span class="nt">destination</span><span class="p">:</span>
        <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary-svc</span> <span class="c1"># referenced in canary.canaryService</span>
      <span class="nt">weight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>
<p>Finally, a canary and stable Service should be deployed. The selector of these Services will be
modified by the Rollout during an update to target the canary and stable ReplicaSet pods.
Note that if virtualservice and destionation host reside in different namespaces (e.g., virtualservice and rollout are not in the same namespace), we should use FQDN as the destination host like <code>stable-svc.&lt;namespace&gt;</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary-svc</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollouts-demo</span>
    <span class="c1"># This selector will be updated with the pod-template-hash of the canary ReplicaSet. e.g.:</span>
    <span class="c1"># rollouts-pod-template-hash: 7bf84f9696</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable-svc</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollouts-demo</span>
    <span class="c1"># This selector will be updated with the pod-template-hash of the stable ReplicaSet. e.g.:</span>
    <span class="c1"># rollouts-pod-template-hash: 123746c88d</span>
</code></pre></div>
<p>During the lifecycle of a Rollout update, Argo Rollouts will continuously:</p>
<ul>
<li>modify the canary Service <code>spec.selector</code> to contain the <code>rollouts-pod-template-hash</code> label of the canary ReplicaSet</li>
<li>modify the stable Service <code>spec.selector</code> to contain the <code>rollouts-pod-template-hash</code> label of the stable ReplicaSet</li>
<li>modify the VirtualService <code>spec.http[].route[].weight</code> to match the current desired canary weight</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Rollout does not make any other assumptions about the fields within the Virtual Service or the Istio mesh. The user could specify additional configurations for the virtual service like URI rewrite rules on the primary route or any other route if desired. The user can also create specific destination rules for each of the services. </p>
</div>
<h2 id="subset-level-traffic-splitting">Subset-level Traffic Splitting<a class="headerlink" href="#subset-level-traffic-splitting" title="Permanent link">&para;</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Available since v1.0</p>
</div>
<p>The second approach to traffic splitting using Argo Rollouts and Istio, is splitting between two
Istio <a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#Subset">DestinationRule Subsets</a>:
a canary subset and a stable subset. When splitting by DestinationRule subsets, the user is
required to deploy the following resources:</p>
<ul>
<li>Rollout</li>
<li>Service</li>
<li>VirtualService</li>
<li>DestinationRule</li>
</ul>
<p>The Rollout should define the following fields:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">argoproj.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Rollout</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
  <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span>
    <span class="nt">canary</span><span class="p">:</span>
      <span class="nt">trafficRouting</span><span class="p">:</span>
        <span class="nt">istio</span><span class="p">:</span>
          <span class="nt">virtualService</span><span class="p">:</span> 
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-vsvc</span>        <span class="c1"># required</span>
            <span class="nt">routes</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>                 <span class="c1"># required</span>
          <span class="nt">destinationRule</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-destrule</span>    <span class="c1"># required</span>
            <span class="nt">canarySubsetName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary</span>  <span class="c1"># required</span>
            <span class="nt">stableSubsetName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable</span>  <span class="c1"># required</span>
      <span class="nt">steps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">setWeight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
      <span class="p p-Indicator">-</span> <span class="nt">pause</span><span class="p">:</span>
          <span class="nt">duration</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10m</span>
</code></pre></div>
<p>A single service should be defined, which target the Rollout pods. Note that unlike the first
approach, where traffic splitting is against multiple Services which are modified to contain the
rollout-pod-template-hash of the canary/stable ReplicaSets, this Service is not modified by
the rollout controller.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
</code></pre></div>
<p>The VirtualService must contain an HTTP route with a name referenced in the Rollout, containing
two route destinations with <code>subset</code> values that match the <code>canarySubsetName</code> and <code>stableSubsetName</code> 
referenced in the Rollout. Note that Istio require that all weights add to 100, so the initial
weights can be be 100% to stable, and 0% to canary.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1alpha3</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-vsvc</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">gateways</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">istio-rollout-gateway</span>
  <span class="nt">hosts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">istio-rollout.dev.argoproj.io</span>
  <span class="nt">http</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>       <span class="c1"># referenced in canary.trafficRouting.istio.virtualService.routes</span>
    <span class="nt">route</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">destination</span><span class="p">:</span>
        <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
        <span class="nt">subset</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable</span>  <span class="c1"># referenced in canary.trafficRouting.istio.destinationRule.stableSubsetName</span>
      <span class="nt">weight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="p p-Indicator">-</span> <span class="nt">destination</span><span class="p">:</span>
        <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
        <span class="nt">subset</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary</span>  <span class="c1"># referenced in canary.trafficRouting.istio.destinationRule.canarySubsetName</span>
      <span class="nt">weight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>
<p>Finally, the DestinationRule containing the canary and stable subsets referenced in the Rollout.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.istio.io/v1alpha3</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DestinationRule</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-destrule</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
  <span class="nt">subsets</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary</span>   <span class="c1"># referenced in canary.trafficRouting.istio.destinationRule.canarySubsetName</span>
    <span class="nt">labels</span><span class="p">:</span>        <span class="c1"># labels will be injected with canary rollouts-pod-template-hash value</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable</span>   <span class="c1"># referenced in canary.trafficRouting.istio.destinationRule.stableSubsetName</span>
    <span class="nt">labels</span><span class="p">:</span>        <span class="c1"># labels will be injected with canary rollouts-pod-template-hash value</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rollout-example</span>
</code></pre></div>
<p>During the lifecycle of a Rollout using Istio DestinationRule, Argo Rollouts will continuously:</p>
<ul>
<li>modify the VirtualService <code>spec.http[].route[].weight</code> to match the current desired canary weight</li>
<li>modify the DestinationRule <code>spec.subsets[].labels</code> to contain the <code>rollouts-pod-template-hash</code>
  label of the canary and stable ReplicaSets</li>
</ul>
<h2 id="comparison-between-approaches">Comparison Between Approaches<a class="headerlink" href="#comparison-between-approaches" title="Permanent link">&para;</a></h2>
<p>There are some advantages and disadvantages of host-level traffic splitting vs. subset-level traffic
splitting.</p>
<h3 id="dns-requirements">DNS requirements<a class="headerlink" href="#dns-requirements" title="Permanent link">&para;</a></h3>
<p>With host-level splitting, the VirtualService requires different <code>host</code> values to split among the
two destinations. However, using two host values implies that there are different DNS names. For
north-south traffic, which reach the service through the Istio Gateway, having multiple DNS names to
reach the canary vs. stable pods may not matter. However, for east-west traffic that happen inside
the cluster, it forces microservice-to-microservice communication to choose whether to hit the
stable or the canary DNS name, go through the gateway, or add DNS entries for the virtualservices.
In this situation, the DestinationRule subset traffic splitting would be a better option for
intra-cluster canarying.</p>
<h3 id="metrics">Metrics<a class="headerlink" href="#metrics" title="Permanent link">&para;</a></h3>
<p>Depending on the choice of host-level splitting vs. subset-level splitting, there will be different
styles of prometheus metrics available. For example, if using host-level splitting, the metrics of
the canary vs. stable would appear in the Istio Service metrics dashboard:</p>
<p><img alt="Istio Service Metrics" src="../istio-service-metrics.png" /></p>
<p>On the other hand, when splitting via subsets, it would be necessary to query prometheus using
different parameters, such as the workload name:</p>
<p><img alt="Istio Workload Metrics" src="../istio-workload-metrics.png" /></p>
<h2 id="integrating-with-gitops">Integrating with GitOps<a class="headerlink" href="#integrating-with-gitops" title="Permanent link">&para;</a></h2>
<p>Earlier it was explained that VirtualServices should be deployed with an initial canary and stable
weight of 0 and 100, respectively, such as in the following example:</p>
<div class="highlight"><pre><span></span><code>  <span class="nt">http</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>
    <span class="nt">route</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">destination</span><span class="p">:</span>
        <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stable-svc</span>
      <span class="nt">weight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="p p-Indicator">-</span> <span class="nt">destination</span><span class="p">:</span>
        <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">canary-svc</span>
      <span class="nt">weight</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</code></pre></div>
<p>This introduces a problem for users practicing GitOps. Since a Rollout will modify these
VirtualService weights as the Rollout progresses through its steps, it unfortunately causes the
VirtualService to become OutOfSync with the version in git. Additionally, if the VirtualService in
git were to be applied while the Rollout is in this state (splitting traffic between the services),
the apply would revert the weights back to the values in git (i.e. 100 to stable, 0 to canary).</p>
<p>One protection which is implemented in Argo Rollouts, is that it continually watches for changes to
managed VirtualServices. In the event that a <code>kubectl apply</code> were to happen using the VirtualService
in git, the change would be detected immediately by the rollout controller, and the controller will
instantly set the VirtualService weights back to the canary weight appropriate for the given step of
the Rollout. But since there is momentary flapping of weights, this behavior should be understood.</p>
<p>Some best practices to follow when using Argo CD with Argo Rollouts to prevent this behavior, is to
leverage the following Argo CD features:</p>
<ol>
<li>
<p>Configure the application to ignore differences in the VirtualService. e.g.:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">argoproj.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Application</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">guestbook</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ignoreDifferences</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">networking.istio.io</span>
    <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
    <span class="nt">jsonPointers</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/spec/http/0</span>
</code></pre></div>
<p>Ignoring the differences in the VirtualServices HTTP route, prevents gitops differences
in the VirtualService HTTP routes to contribute to the overall sync status of the Argo CD
application. This adds the additional benefit of prevent auto-sync operations from being
triggered.</p>
</li>
<li>
<p>Configure the Application to only apply OutOfSync resources:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">argoproj.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Application</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">guestbook</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">syncPolicy</span><span class="p">:</span>
    <span class="nt">syncOptions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ApplyOutOfSyncOnly=true</span>
</code></pre></div>
<p>By default, when Argo CD  syncs an application, it runs <code>kubectl apply</code> against all resources in
git which are part of the application. The <code>ApplyOutOfSyncOnly=true</code> sync option indicates to
Argo CD to skip applying resources which it already considers <code>Synced</code>, and only apply the ones
which are <code>OutOfSync</code>. This option, when used in conjunction with the <code>ignoreDifferences</code>
feature, provides a way to manage the conflict in the desired state of a VirtualService between
Argo CD and Argo Rollouts.</p>
</li>
</ol>
<p>Argo CD also has an <a href="https://github.com/argoproj/argo-cd/issues/2913">open issue here</a> which would
help address this problem. The proposed solution is to introduce an annotation to resources, which
indicates to Argo CD to respect and preserve the differences at a specified path, in order to allow
other controllers (e.g. Argo Rollouts) controller manage them instead.</p>
<h2 id="alternatives-considered">Alternatives Considered<a class="headerlink" href="#alternatives-considered" title="Permanent link">&para;</a></h2>
<h3 id="rollout-ownership-over-the-virtual-service">Rollout ownership over the Virtual Service<a class="headerlink" href="#rollout-ownership-over-the-virtual-service" title="Permanent link">&para;</a></h3>
<p>An early design alternative was that instead of the controller modifying a referenced VirtualService, the Rollout controller would create, manage, and own a Virtual Service. While this approach is GitOps friendly, it introduces other issues:</p>
<ul>
<li>To provide the same flexibility as referencing VirtualService within a Rollout, the Rollout needs to inline a large portion of the Istio spec. However, networking is outside the responsibility of the Rollout and makes the Rollout spec unnecessary complicated.</li>
<li>If Istio introduces a feature, that feature will not be available in Argo Rollouts until implemented within Argo Rollouts.</li>
</ul>
<p>Both of these issues adds more complexity to the users and Argo Rollouts developers compared to referencing a Virtual Service.</p>
<h3 id="istio-support-through-the-smi-adapter-for-istio">Istio support through the <a href="https://github.com/servicemeshinterface/smi-adapter-istio">SMI Adapter for Istio</a><a class="headerlink" href="#istio-support-through-the-smi-adapter-for-istio" title="Permanent link">&para;</a></h3>
<p><a href="https://smi-spec.io/">SMI</a> is the Service Mesh Interface, which serves as a standard interface for all common features of a service mesh. This feature is GitOps friendly, but native Istio has extra functionality that SMI does not currently provide.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../alb/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              AWS ALB
            </div>
          </div>
        </a>
      
      
        <a href="../nginx/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              NGINX
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.d351de03.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.a1609d9a.min.js"></script>
      
    
  </body>
</html>